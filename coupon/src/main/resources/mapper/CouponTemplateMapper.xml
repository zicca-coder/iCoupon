<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zicca.icoupon.coupon.dao.mapper.CouponTemplateMapper">

    <sql id="column">
        id
        ,
        name,
        shop_id,
        target,
        type,
        face_value,
        min_amount,
        max_discount_amount,
        max_random_amount,
        stock,
        valid_start_time,
        valid_end_time,
        max_receive_per_user,
        status
    </sql>

    <sql id="allColumn">
        <include refid="column"/>
        ,
        create_time,
        update_time,
        create_by,
        update_by,
        del_flag
    </sql>

    <sql id="insertValue">
        #{id}
        ,
        #{name},
        #{shopId},
        #{target.code},
        #{type.code},
        #{faceValue},
        #{minAmount},
        #{maxDiscountAmount},
        #{maxRandomAmount},
        #{stock},
        #{validStartTime},
        #{validEndTime},
        #{maxReceivePerUser},
        #{status.code},
        #{createTime},
        #{updateTime},
        #{createBy},
        #{updateBy},
        #{delFlag}
    </sql>

    <sql id="baseCondition">
        <if test="id != null">
            AND id = #{id}
        </if>
        <if test="shopId != null">
            AND shop_id = #{shopId}
        </if>
        AND del_flag = 0
    </sql>


    <insert id="insertCouponTemplate">
        INSERT INTO
        t_coupon_template (
        <include refid="allColumn"/>
        ) VALUES (
        <include refid="insertValue"/>
        )
    </insert>


    <!--增加优惠券模板发行量-->
    <update id="increaseNumberCouponTemplate">
        UPDATE t_coupon_template
        SET stock = stock + #{number}
        WHERE id = #{couponTemplateId}
          AND shop_id = #{shopId}
    </update>

    <!--减少优惠券模板发行量-->
    <update id="decreaseNumberCouponTemplate">
        UPDATE t_coupon_template
        SET stock = stock - #{number}
        WHERE id = #{couponTemplateId}
          AND shop_id = #{shopId}
          AND stock >= #{number}
    </update>

    <select id="selectCouponTemplateById" resultType="com.zicca.icoupon.coupon.dao.entity.CouponTemplate">
        SELECT
        <include refid="column"/>
        FROM t_coupon_template
        WHERE 1=1
        <include refid="baseCondition"/>
    </select>

    <select id="selectCouponTemplateByIds" resultType="com.zicca.icoupon.coupon.dao.entity.CouponTemplate">
        SELECT
        <include refid="column"/>
        FROM t_coupon_template
        WHERE 1=1
        AND id IN
        <foreach item="item" index="index" collection="couponTemplateIds" separator="," open="(" close=")">
            #{item}
        </foreach>
        AND shop_id IN
        <foreach item="item" index="index" collection="shopIds" separator="," open="(" close=")">
            #{item}
        </foreach>
        AND del_flag = 0
    </select>

    <select id="selectCouponTemplateListByShopId" resultType="com.zicca.icoupon.coupon.dao.entity.CouponTemplate">
        SELECT
        <include refid="column"/>
        FROM t_coupon_template
        WHERE 1=1
        AND shop_id = #{shopId}
        AND del_flag = 0
        AND valid_end_time > NOW()
        ORDER BY type, valid_start_time ASC
    </select>

    <select id="selectCouponTemplateListByShopIdAndStatus"
            resultType="com.zicca.icoupon.coupon.dao.entity.CouponTemplate">
        SELECT
        <include refid="column"/>
        FROM t_coupon_template
        WHERE 1=1
        AND shop_id = #{shopId}
        AND status = #{status}
        AND del_flag = 0
        AND valid_end_time > NOW()
        ORDER BY type, valid_start_time ASC
    </select>

    <select id="selectCouponTemplateListByShopIdAndType"
            resultType="com.zicca.icoupon.coupon.dao.entity.CouponTemplate">
        SELECT
        <include refid="column"/>
        FROM t_coupon_template
        WHERE 1=1
        AND shop_id = #{shopId}
        AND type = #{type}
        AND del_flag = 0
        AND valid_end_time > NOW()
        ORDER BY valid_start_time ASC
    </select>

    <select id="fetchCouponTemplateIds" resultType="java.lang.Long">
        SELECT id
        FROM t_coupon_template
        WHERE 1=1
        AND del_flag = 0
        AND status != 2
        AND status != 3
        AND valid_end_time > NOW()
    </select>

    <delete id="deleteCouponTemplateByIdAndShopId">
        DELETE
        FROM t_coupon_template
        WHERE id = #{id}
          AND shop_id = #{shopId}
          AND del_flag = 0
    </delete>

    <update id="updateCouponTemplateStatusByIdAndShopId">
        UPDATE
        t_coupon_template
        SET status = #{status.code}
        WHERE id = #{id}
          AND shop_id = #{shopId}
          AND del_flag = 0
    </update>


</mapper>