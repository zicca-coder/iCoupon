<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zicca.icoupon.goods.dao.mapper.GoodsMapper">

    <sql id="table">
        t_goods
    </sql>

    <sql id="baseColumn">
        id
        ,
        shop_id,
        name,
        price,
        original_price,
        stock,
        status,
        coupon_support_type
    </sql>

    <sql id="column">
        <include refid="baseColumn"/>,
        create_time,
        update_time,
        create_by,
        update_by,
        del_flag
    </sql>

    <sql id="insertValues">
        #{goods.id}
        ,
        #{goods.shopId},
        #{goods.name},
        #{goods.price},
        #{goods.originalPrice},
        #{goods.stock},
        #{goods.status.code},
        #{goods.couponSupportType.code},
        #{goods.createTime},
        #{goods.updateTime},
        #{goods.createBy},
        #{goods.updateBy},
        #{goods.delFlag}
    </sql>

    <insert id="insertGoods">
        INSERT INTO
        <include refid="table"/>
        (
        <include refid="column"/>
        )
        VALUES(
        <include refid="insertValues"/>
        )
    </insert>

    <insert id="batchInsertGoods">
        INSERT INTO
        <include refid="table"/>
        (
        <include refid="column"/>
        )
        VALUES
        <foreach item="goods" index="index" collection="goodsList" separator=",">
            (
            <include refid="insertValues"/>
            )
        </foreach>
    </insert>

    <select id="selectGoodsById" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
        <include refid="baseColumn"/>
        FROM
        <include refid="table"/>
        WHERE id = #{id}
        AND del_flag = 0
    </select>

    <select id="selectGoodsByIdAndShopId" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
        <include refid="baseColumn"/>
        FROM
        <include refid="table"/>
        WHERE id = #{id}
        AND shop_id = #{shopId}
        AND del_flag = 0
    </select>

    <select id="selectGoodsListByShopId" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
        <include refid="baseColumn"/>
        FROM
        <include refid="table"/>
        WHERE shop_id = #{shopId}
        AND del_flag = 0
    </select>

    <select id="selectGoodsListByIds" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
        <include refid="baseColumn"/>
        FROM
        <include refid="table"/>
        WHERE id IN
        <foreach item="id" index="index" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
        AND del_flag = 0
    </select>

    <select id="selectGoodsListByIdsAndUserId" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
        <include refid="baseColumn"/>
        FROM
        <include refid="table"/>
        WHERE id IN
        <foreach item="id" index="index" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
        AND user_id = #{userId}
        AND del_flag = 0
    </select>

    <update id="deleteGoodsById">
        UPDATE
        <include refid="table"/>
        SET
        del_flag = 1
        WHERE id = #{id}
    </update>

    <update id="deleteGoodsByIdAndShopId">
        UPDATE
        <include refid="table"/>
        SET
        del_flag = 1
        WHERE id = #{id}
        AND shop_id = #{shopId}
    </update>

    <update id="batchDeleteGoodsByIds">
        UPDATE
        <include refid="table"/>
        SET
        del_flag = 1
        WHERE id IN
        <foreach item="id" index="index" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

    <update id="batchDeleteGoodsByIdsAndShopId">
        UPDATE
        <include refid="table"/>
        SET
        del_flag = 1
        WHERE id IN
        <foreach item="id" index="index" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
        AND shop_id = #{shopId}
    </update>

    <update id="increaseNumberGoods">
        UPDATE
        <include refid="table"/>
        SET
        stock = stock + #{number}
        WHERE id = #{id}
        AND shop_id = #{shopId}
    </update>

    <update id="decreaseNumberGoods">
        UPDATE
        <include refid="table"/>
        SET
        stock = stock - #{number}
        WHERE id = #{id}
        AND shop_id = #{shopId}
        AND stock >= #{number}
    </update>

    <select id="selectDiscountedGoodsList" resultType="com.zicca.icoupon.goods.dao.entity.Goods">
        SELECT
            <include refid="baseColumn"/>
            FROM
            <include refid="table"/>
            WHERE shop_id = #{shopId}
            AND price <![CDATA[<]]> original_price
            AND status = 0
            AND del_flag = 0
    </select>


</mapper>